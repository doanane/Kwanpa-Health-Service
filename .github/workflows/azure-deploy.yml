name: Deploy to Azure

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          # Create requirements.txt if missing
          if [ ! -f requirements.txt ]; then
            echo "fastapi" > requirements.txt
            echo "uvicorn[standard]" >> requirements.txt
            echo "gunicorn" >> requirements.txt
            echo "sqlalchemy" >> requirements.txt
            echo "psycopg2-binary" >> requirements.txt
          fi
          pip install -r requirements.txt

      - name: Create startup file
        run: |
          echo "gunicorn app.main:app --workers 2 --bind 0.0.0.0:8000" > startup.txt

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy using ZIP Deploy (direct)
        run: |
          # Zip the application
          zip -r deploy.zip . -x '*.git*' '*.github*'
          
          # Deploy using direct REST API
          curl -X POST \
            -H "Authorization: Bearer $(az account get-access-token --resource https://management.azure.com --query accessToken -o tsv)" \
            -H "Content-Type: application/zip" \
            --data-binary @"deploy.zip" \
            "https://hewal3-backend-api-aya3dzgefte4b3c3.scm.southafricanorth-01.azurewebsites.net/api/zipdeploy"