name: Deploy to Azure

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Install core packages explicitly
          pip install fastapi uvicorn[standard] gunicorn sqlalchemy psycopg2-binary
          # Then install from requirements.txt if it exists
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Login to Azure (using AZURE_CREDENTIALS)
        uses: azure/login@v2 # Updated to v2 for better stability
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Restart App Service (prevents 409 conflicts)
        run: |
          echo "Restarting App Service to clear any stuck deployments..."
          az webapp restart --name hewal3-backend-api --resource-group hewal3-backend-api_group
          echo "Waiting 30 seconds for restart to complete..."
          sleep 30

      - name: Deploy to Azure Web App with retry logic
        uses: azure/webapps-deploy@v3 # Updated to v3
        continue-on-error: true # Don't fail on first attempt
        id: deploy-attempt
        with:
          app-name: "hewal3-backend-api"
          package: "."

      - name: Retry deployment if first attempt failed
        if: steps.deploy-attempt.outcome == 'failure'
        run: |
          echo "First deployment failed (likely 409 conflict). Waiting 60 seconds..."
          sleep 60
          echo "Retrying deployment..."

      - name: Final deployment attempt
        if: steps.deploy-attempt.outcome == 'failure'
        uses: azure/webapps-deploy@v3
        with:
          app-name: "hewal3-backend-api"
          package: "."
